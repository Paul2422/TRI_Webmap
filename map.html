<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive GIS Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
  #header { height: 60px; background-color: #2c3e50; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; }
  #dashboard { display: flex; height: calc(100% - 60px); }
  #leftPanel { width: 250px; background: #ecf0f1; padding: 10px; box-sizing: border-box; border-right: 1px solid #bdc3c7; overflow-y: auto; }
  #centerPanel { flex: 1; position: relative; }
  #map { width: 100%; height: 100%; cursor: grab; }
  #rightPanel { width: 250px; background: #ecf0f1; padding: 10px; box-sizing: border-box; border-left: 1px solid #bdc3c7; overflow-y: auto; }
  .panel-title { font-weight: bold; margin-bottom: 10px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 4px; font-size: 12px; }
</style>
</head>
<body>

<div id="header">Interactive GIS Dashboard</div>

<div id="dashboard">
  <!-- LEFT PANEL: Legend -->
  <div id="leftPanel">
    <div class="panel-title">Legend & Layers</div>
    <div id="legend"></div>
  </div>

  <!-- CENTER PANEL: MAP -->
  <div id="centerPanel">
    <div id="map"></div>
  </div>

  <!-- RIGHT PANEL: Feature Info -->
  <div id="rightPanel">
    <div class="panel-title">Feature Info</div>
    <div id="featureInfo">Click on a layer to see feature attributes.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ============================
// 1. CREATE MAP
// ============================
const map = L.map('map').setView([10, 125], 6);

// ============================
// 2. BASEMAPS
// ============================
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom: 19 }).addTo(map);
const satellite = L.tileLayer('http://mt0.google.com/vt/lyrs=s&hl=en&x={x}&y={y}&z={z}', { subdomains:['mt0','mt1','mt2','mt3'], attribution:'© Google', maxZoom:25 });

// ============================
// 3. WMS LAYERS
// ============================
const layers = {
  "MPSA": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:MPSA', format:'image/png', transparent:true, version:'1.1.1',crs: L.CRS.EPSG3857, tiled:true, maxZoom:22 }).addTo(map),
  "MPSA_Buffer": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:MPSA_Bufferzone', format:'image/png', transparent:true, version:'1.1.1',crs: L.CRS.EPSG3857, tiled:true, maxZoom:22 }),
  "Mine Area/Block": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:Mine Areas', format:'image/png', transparent:true, version:'1.1.1',crs: L.CRS.EPSG3857, tiled:true, maxZoom:22 }),
  "QAS_Station": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:Quality Air Sampling Station', format:'image/png', transparent:true, version:'1.1.1',crs: L.CRS.EPSG3857, tiled:true }),
  "Silt Trap 2025": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:Silt Trap 2025', format:'image/png', transparent:true, version:'1.1.1', crs: L.CRS.EPSG3857, tiled:true, maxZoom:22 }),
  "Orthophoto": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:odm_orthophoto', format:'image/png', transparent:true, version:'1.1.1', crs: L.CRS.EPSG3857, tiled:true, maxZoom:22 }),
  "MFP_TRP_PRP": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:MFP_TRP_PRP', format:'image/png', transparent:true, version:'1.1.1',crs: L.CRS.EPSG3857, tiled:true, maxZoom:22 }),
  "Updated Mine Area 2025": L.tileLayer.wms('http://localhost:8080/geoserver/wms', { layers:'TRI_Web:Updated Mine Area 2025', format:'image/png', transparent:true, version:'1.1.1',crs: L.CRS.EPSG3857, tiled:true, maxZoom:22 })
};


// ============================
// 4. LAYER CONTROL
// ============================
const baseMaps = { "OSM": osm, "Satellite": satellite };
L.control.layers(baseMaps, layers, {collapsed:true}).addTo(map);

// ============================
// 5. FIT MAP TO MPSA
// ============================
map.fitBounds([[10.6905,125.7498],[10.7363,125.8097]]);

// ============================
// 6. UPDATE LEGEND FUNCTION
// ============================
function updateLegend() {
    const legendDiv = document.getElementById('legend');
    legendDiv.innerHTML = '';
    for (const key in layers) {
        if (map.hasLayer(layers[key])) {
            const layerName = layers[key].wmsParams.layers;
            const img = document.createElement('img');
            img.src = `http://localhost:8080/geoserver/TRI_Web/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&LAYER=${layerName}`;
            img.style.width = '20px';
            img.style.height = '20px';
            legendDiv.appendChild(document.createTextNode(key + ' '));
            legendDiv.appendChild(img);
            legendDiv.appendChild(document.createElement('br'));
        }
    }
}

// Update legend whenever a layer is toggled
map.on('overlayadd', updateLegend);
map.on('overlayremove', updateLegend);

// Initial legend
updateLegend();

// ============================
// 7. FEATURE INFO POPUP
// ============================
map.on('click', function(e){
    let featureFound = false;
    Object.keys(layers).forEach(layerKey => {
        const layer = layers[layerKey];
        if(map.hasLayer(layer)){
            const size = map.getSize();
            const bounds = map.getBounds().toBBoxString();
            const point = map.latLngToContainerPoint(e.latlng);

            const url = `${layer._url}?service=WMS&request=GetFeatureInfo&version=${layer.wmsParams.version}&layers=${layer.wmsParams.layers}&query_layers=${layer.wmsParams.layers}&bbox=${bounds}&width=${size.x}&height=${size.y}&info_format=application/json&srs=EPSG:4326&x=${Math.floor(point.x)}&y=${Math.floor(point.y)}`;

            fetch(url)
            .then(res => res.json())
            .then(data => {
                if(data.features && data.features.length>0){
                    featureFound = true;
                    const props = data.features[0].properties;

                    // Popup
                    let html = "<table>";
                    for(let k in props){
                        html += `<tr><th>${k}</th><td>${props[k]}</td></tr>`;
                    }
                    html += "</table>";
                    L.popup({ maxWidth: 300 }).setLatLng(e.latlng).setContent(html).openOn(map);

                    // Right panel
                    document.getElementById('featureInfo').innerHTML = html;
                }
            })
            .catch(err => console.log(err));
        }
    });

    if(!featureFound){
        document.getElementById('featureInfo').innerHTML = "No features found at this location.";
    }
});

// ============================
// 8. CURSOR POINTER HOVER
// ============================
map.on('mousemove', function(){
    let overLayer = false;
    Object.values(layers).forEach(layer => { if(map.hasLayer(layer)) overLayer = true; });
    map.getContainer().style.cursor = overLayer ? 'pointer' : 'grab';
});
map.on('mousedown', function(){ map.getContainer().style.cursor = 'grabbing'; });
map.on('mouseup', function(){ map.getContainer().style.cursor = 'pointer'; });

</script>
</body>
</html>
